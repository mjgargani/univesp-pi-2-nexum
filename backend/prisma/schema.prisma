// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// Based on the file: ../../new_erd.yml

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model RoleTemplate {
  id    String   @id @default(uuid())
  active Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  name  String   @unique // Ex: "ADMIN", "CUSTOMER", "MANAGER", etc.
  complement  String?
  
  // Relação de volta para a tabela de junção
  users UserRoleTemplate[]

  @@map("role_templates")
}
model User {
  id          String    @id @default(uuid())
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at") // Mapeia o campo createdAt para a coluna created_at
  updatedAt   DateTime  @updatedAt @map("updated_at") // @updatedAt é a convenção do Prisma
  userName    String    @unique @map("user_name") // Mapeia o campo userName para a coluna user_name
  password    String
  document    String    @unique
  firstName   String    @map("first_name") // Mapeia o campo firstName para a coluna first_name
  middleName  String?   @map("middle_name") // Mapeia o campo middleName para a coluna middle_name
  lastName    String    @map("last_name") // Mapeia o campo lastName para a coluna last_name
  birthDate   DateTime? @map("birth_date") // Mapeia o campo birthDate para a coluna birth_date
  complement  String?

  roles       UserRoleTemplate[] // Relação 1:N com UserRoleTemplate
  
  contacts    UserContact[] // Relação 1:N com UserContact

  addresses   UserAddress[] // Relação 1:N com UserAddress

  vehicles    UserVehicleTemplate[] // Relação 1:N com UserVehicleTemplate

  @@map("users") // Mapeia este modelo para a tabela 'users'
}

// Schema to DB mapping

model Supplier {
  id            String    @id @default(uuid())
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  companyName   String    @map("company_name")
  document      String    @unique
  complement    String?

  contacts      SupplierContact[] // Relação 1:N com SupplierContact

  addresses     SupplierAddress[] // Relação 1:N com SupplierAddress

  parts         PartTemplateSupplier[] // Relação 1:N com PartTemplateSupplier

  @@map("suppliers")
}

model PartTemplate {
  id          String    @id @default(uuid())
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  name        String
  description String
  value       Float
  complement  String?

  orders      OrderPartTemplate[] // Relação 1:N com OrderPartTemplate

  suppliers   PartTemplateSupplier[] // Relação 1:N com PartTemplateSupplier

  @@map("part_templates")
}

model Manufacturer {
  id          String    @id @default(uuid())
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  name        String
  description String
  complement  String?

  vehicles    VehicleTemplate[] // Relação 1:N com VehicleTemplate

  @@map("manufacturers")
}

// ContactType enum definition

enum ContactType {
  PHONE
  MAIL
}

model Contact {
  id          String      @id @default(uuid())
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  type        ContactType
  content     String
  complement  String?

  users       UserContact[] // Relação 1:N com UserContact

  suppliers   SupplierContact[] // Relação 1:N com SupplierContact

  @@map("contacts")
}

model Address {
  id           String    @id @default(uuid())
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  street       String
  number       String
  neighborhood String
  city         String
  state        String
  country      String
  zipCode      String    @map("zip_code")
  complement   String?

  users        UserAddress[] // Relação 1:N com UserAddress

  suppliers    SupplierAddress[] // Relação 1:N com SupplierAddress

  @@map("addresses")
}

model ServiceTemplate {
  id          String    @id @default(uuid())
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  value       Float
  name        String
  description String
  complement  String?

  steps       ServiceStep[] // Relação 1:N com ServiceStep

  orders      OrderServiceTemplate[] // Relação 1:N com OrderServiceTemplate

  @@map("service_templates")
}

// N:1

model VehicleTemplate {
  id              String        @id @default(uuid())
  active          Boolean       @default(true)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  name            String
  complement      String?

  // Relação N:1 com UserVehicleTemplate
  users           UserVehicleTemplate[]

  // Relação N:1 com Manufacturer
  manufacturerId  String  @map("manufacturer_id")
  manufacturer    Manufacturer  @relation(fields: [manufacturerId], references: [id])

  @@map("vehicle_templates")
}

model Order {
  id          String    @id @default(uuid())
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  number      Int       @unique
  scheduled   DateTime
  conclusion  DateTime?
  budget      Float
  value       Float
  complement  String?

  // Relação N:1 com a instância do veículo do usuário
  userVehicleTemplateId   String @map("user_vehicle_template_id")
  userVehicleTemplate     UserVehicleTemplate @relation(fields: [userVehicleTemplateId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  statuses   OrderStatus[] // Relação 1:N com OrderStatus

  services   OrderServiceTemplate[] // Relação 1:N com OrderServiceTemplate

  parts      OrderPartTemplate[]    // Relação 1:N com OrderPartTemplate

  @@map("orders")
}

// 'Singleton' para controle do último número de ordem utilizado
model OrderCounter {
  id        Int @id @default(1)
  lastOrder Int @default(1000) // Começa a contagem em 1000

  @@map("order_counter")
}

model ServiceStep {
  id                  String  @id @default(uuid())
  active              Boolean @default(true)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  stepNumber          Int @map("step_number")
  name                String
  description         String
  complement          String?

  // Relação N:1 com ServiceTemplate
  serviceTemplateId   String  @map("service_template_id")
  serviceTemplate     ServiceTemplate @relation(fields: [serviceTemplateId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("service_steps")
}

model OrderStatus {
  id          String    @id @default(uuid())
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  description String
  complement  String?

  // Relação N:1 com Order
  orderId   String  @map("order_id")
  order     Order  @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("order_statuses")
}

// N:N

model OrderServiceTemplate {
  id                  String   @id @default(uuid())
  active              Boolean  @default(true)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relação 1:N com Order
  orderId             String  @map("order_id")
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Relação 1:N com ServiceTemplate
  serviceTemplateId   String  @map("service_template_id")
  serviceTemplate     ServiceTemplate @relation(fields: [serviceTemplateId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("order_service_templates")
}

model OrderPartTemplate {
  id               String   @id @default(uuid())
  active           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relação 1:N com Order
  orderId           String  @map("order_id")
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Relação 1:N com PartTemplate
  partTemplateId    String  @map("part_template_id")
  partTemplate      PartTemplate @relation(fields: [partTemplateId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("order_part_templates")
}

model UserContact {
  id         String   @id @default(uuid())
  active     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relação 1:N com User
  userId    String  @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Relação 1:N com Contact
  contactId String  @map("contact_id")
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("users_contacts")
}

model UserAddress {
  id         String   @id @default(uuid())
  active     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relação 1:N com User
  userId    String  @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Relação 1:N com Address
  addressId String  @map("address_id")
  address   Address  @relation(fields: [addressId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("users_addresses")
}

model SupplierContact {
  id            String   @id @default(uuid())
  active        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relação 1:N com Supplier
  supplierId    String @map("supplier_id")
  supplier      Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Relação 1:N com Contact
  contactId     String @map("contact_id")
  contact       Contact @relation(fields: [contactId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("suppliers_contacts")
}

model SupplierAddress {
  id          String   @id @default(uuid())
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relação 1:N com Supplier
  supplierId String @map("supplier_id")
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Relação 1:N com Address
  addressId  String @map("address_id")
  address    Address @relation(fields: [addressId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("suppliers_addresses")
}

model PartTemplateSupplier {
  id               String   @id @default(uuid())
  active           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relação 1:N com PartTemplate
  partTemplateId  String @map("part_template_id")
  partTemplate    PartTemplate @relation(fields: [partTemplateId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Relação 1:N com Supplier
  supplierId      String @map("supplier_id")
  supplier        Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("part_templates_suppliers")
}

model UserRoleTemplate {
  active           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relação 1:N com User
  userId String @map("user_id")
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade) // Deleta/Altera a relação se o usuário for deletado
  
  // Relação 1:N com RoleTemplate
  roleTemplateId String @map("role_template_id")
  roleTemplate RoleTemplate @relation(fields: [roleTemplateId], references: [id], onDelete: Cascade, onUpdate: Cascade) // Deleta/Altera a relação se o papel for deletado

  // Chave primária composta (garante que um usuário não pode ter o mesmo papel duas vezes)
  @@id([userId, roleTemplateId])
  @@map("users_role_templates")
}

model UserVehicleTemplate {
  id         String   @id @default(uuid())
  active     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  year       Int
  color      String
  complement String?

  // Relação 1:N com User
  userId    String  @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Relação 1:N com VehicleTemplate
  vehicleTemplateId String  @map("vehicle_template_id")
  vehicleTemplate   VehicleTemplate  @relation(fields: [vehicleTemplateId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  orders          Order[]       // Relação 1:N com Order (UMA instância de carro pode ter VÁRIAS ordens)

  @@map("users_vehicle_templates")
}